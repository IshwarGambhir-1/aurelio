package com.yash.luxevite.categoryservice.repository;


import java.util.List;
import java.util.Optional;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import com.yash.luxevite.categoryservice.model.Category;
import com.yash.luxevite.categoryservice.model.CategoryGender;
import com.yash.luxevite.categoryservice.model.CategoryStatus;

/**
 * Repository interface for Category entity
 * Provides CRUD operations and custom query methods
 */
@Repository
public interface CategoryRepository extends JpaRepository<Category, Long> {

    // Find categories by gender
    List<Category> findByGender(CategoryGender gender);

    // Find categories by gender with pagination
    Page<Category> findByGender(CategoryGender gender, Pageable pageable);

    // Find categories by status
    List<Category> findByStatus(CategoryStatus status);

    // Find categories by gender and status
    List<Category> findByGenderAndStatus(CategoryGender gender, CategoryStatus status);

    // Find featured categories
    List<Category> findByIsFeaturedTrue();

    // Find categories by gender that are featured
    List<Category> findByGenderAndIsFeaturedTrue(CategoryGender gender);

    // Find root categories (no parent)
    List<Category> findByParentCategoryIsNull();

    // Find root categories by gender
    List<Category> findByParentCategoryIsNullAndGender(CategoryGender gender);

    // Find subcategories by parent category ID
    List<Category> findByParentCategoryId(Long parentId);

    // Find categories by parent category ID with status
    List<Category> findByParentCategoryIdAndStatus(Long parentId, CategoryStatus status);

    // Find category by slug
    Optional<Category> findBySlug(String slug);

    // Find category by name and gender
    Optional<Category> findByNameAndGender(String name, CategoryGender gender);

    // Check if category exists by name and gender
    boolean existsByNameAndGender(String name, CategoryGender gender);

    // Check if slug exists
    boolean existsBySlug(String slug);

    // Search categories by name
    @Query("SELECT c FROM Category c WHERE " +
           "LOWER(c.name) LIKE LOWER(CONCAT('%', :query, '%')) OR " +
           "LOWER(c.description) LIKE LOWER(CONCAT('%', :query, '%'))")
    Page<Category> searchCategories(@Param("query") String query, Pageable pageable);

    // Find categories with product count (for reporting)
    @Query("SELECT c, COUNT(p) as productCount FROM Category c LEFT JOIN c.products p GROUP BY c")
    Page<Object[]> findCategoriesWithProductCount(Pageable pageable);

    // Find categories by gender with product count
    @Query("SELECT c, COUNT(p) as productCount FROM Category c LEFT JOIN c.products p " +
           "WHERE c.gender = :gender GROUP BY c")
    List<Object[]> findCategoriesByGenderWithProductCount(@Param("gender") CategoryGender gender);

    // Find active categories ordered by display order
    List<Category> findByStatusOrderByDisplayOrderAsc(CategoryStatus status);

    // Find categories by gender ordered by display order
    List<Category> findByGenderOrderByDisplayOrderAsc(CategoryGender gender);

    // Find active categories by gender ordered by display order
    List<Category> findByGenderAndStatusOrderByDisplayOrderAsc(CategoryGender gender, CategoryStatus status);
}